---
title: "Intervalos de Confianza"
output: html_notebook
---
Simulación de **Coverage Probability of Confidence Intervals**
```{r,message=FALSE,warning=FALSE}
library(ggplot2)
library(tidyverse)
```


### Muestras normales estándar

Función que genera un dataframe a partir **N** muestras aleatorias normales de tamaño **n** con probabilidad acumulada **z** (que corresponderá al $z_{1-\frac{\alpha}{2}}$ para los intervalos de confianza). La información contenida en el dataframe es:

1. Número de muestra
2. Tamaño de muestra (n)
3. Media muestral ($\bar{X}$)
4. Desviación estándar ($\sigma$)
5. Error ($\frac{\sigma}{\sqrt{n}}\cdot z_{1-\frac{\alpha}{2}}$) donde $z_{1-\frac{\alpha}{2}}$ es el percentil $1- \frac{\alpha}{2}$ de una $N \sim (0,1)$
6. Límite inferior del intervalo de confianza ($\bar{X} - \frac{\sigma}{\sqrt{n}}\cdot z_{1-\frac{\alpha}{2}}$)
7. Límite superior del IC ($\bar{X} + \frac{\sigma}{\sqrt{n}}\cdot z_{1-\frac{\alpha}{2}}$)
```{r}
muIC <- function(n=50,N=10000,z=0.975)
{
  set.seed(123)

  df <- data.frame(matrix(NA,n,7))
  colnames(df) <- c('# de muestra','n','media','desv. est.','error','LI','LS')
  
  for(i in 1:N)
  {
    x <- rnorm(n)    # Creamos una muestra de tamaño N
    mu <- mean(x)
    sigma <- sd(x)
    error <- qnorm(z)*sigma/sqrt(n)
    
    df[i,1] <- i
    df[i,2] <- n
    df[i,3] <- mu
    df[i,4] <- sigma
    df[i,5] <- error
    df[i,6] <- mu - error
    df[i,7] <- mu + error
  }
  
  return(df)
}
```


Probamos la función
```{r}
# IC del 90% = (1-0.1)%
# con percentil de 1-0.05=.95
muNormal <- muIC(z=0.95)
muNormal
cuentaCI(muNormal)
```

Función para contar la proporción de muestras cuyos intervalos de confianza contienen al valor del parámetro; es decir, si quisimos un IC del 95% para la muestra entonces el aproximadamente 95% de los IC de las muestras dadas deben contener al parámetro poblacional $\mu = 0$ (pues las muestras son normales estándar)
```{r}
cuentaCI <- function(dataframe)
{
  n <- dataframe$n
  N <- length(n)
  mu <- dataframe$media
  lower <- dataframe$LI
  upper <- dataframe$LS
  res <- 0
  c <- 0
  
  for(i in 1:N)
  {
    
    if(0>=lower[i] & 0<=upper[i])
    {
      c = c + 1
    }
  }
  
  res <- c/N*100
  
  return(res)
  
}
```


Función para graficar los intervalos de confianza de las muestras dadas
```{r}
data <- muNormal %>% slice(1:150)
x <- data$`# de muestra`
mu <- data$media
L <- data$LI
U <- data$LS

ggplot(data, aes(x = x, y=mu, color=(L>0 | U<0))) +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, color = 'red', size = 1) +
  geom_errorbar(aes(ymax = U, ymin = L)) +
  scale_colour_manual(values = c('gray20','red')) +
  ggtitle(expression('Intervalos de Confianza para '~mu)) +
  theme(plot.title = element_text(hjust = 0.5), legend.position = 'none') +
  xlab('# de muestra') +
  ylab('IC')
```

Función para graficar los intervalos de confianza de las muestras dadas
```{r}
graphCI <- function(df,min=1,max=100)
{
  data <- df %>% slice(min:max)
  x <- data$`# de muestra`
  mu <- data$media
  L <- data$LI
  U <- data$LS
  
  ggplot(data, aes(x = x, y=mu, color=(L>0 | U<0))) +
    geom_point(size = 3) +
    geom_hline(yintercept = 0, color = 'red', size = 1) +
    geom_errorbar(aes(ymax = U, ymin = L)) +
    scale_colour_manual(values = c('gray20','red')) +
    ggtitle(expression('Intervalos de Confianza para '~mu)) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = 'none') +
    xlab('# de muestra') +
    ylab('IC')
}
```


Probamos con intervalos de confianza del $50\%$ (con $\alpha=0.5$ y $\frac{\alpha}{2} = 0.25$)
```{r}
ic50 <- muIC(z=0.75)
ic50

cuentaCI(ic50)

graphCI(ic50,1,200)
```


Probamos con intervalos de confianza del $95\%$ (con $\alpha=0.05$ y $\frac{\alpha}{2} = 0.025$)
```{r}
ic95 <- muIC(z=0.975)
ic95

cuentaCI(ic95)

graphCI(ic95,1,200)
```


### Muestras Bernoulli

Función que genera un dataframe a partir **N** muestras aleatorias $bernoullis(\theta)$ de tamaño **n** con con probabilidad acumulada **z** (que corresponderá al $z_{1-\frac{\alpha}{2}}$ para los intervalos de confianza). La información contenida en el dataframe es:

1. Número de muestra
2. Tamaño de muestra (n)
3. Theta de la distribución ($\theta$)
4. Media muestral ($\bar{X}$)
5. Desviación estándar ($\sqrt{\frac{\bar{X}(1-\bar{X})}{n}}$)
6. Error ($\sqrt{\frac{\bar{X}(1-\bar{X})}{n}} \cdot z_{1-\frac{\alpha}{2}}$) donde $z_{1-\frac{\alpha}{2}}$ es el percentil $1- \frac{\alpha}{2}$ de una $N \sim (0,1)$
7. Límite inferior del intervalo de confianza ($\bar{X} - \sqrt{\frac{\bar{X}(1-\bar{X})}{n}} \cdot z_{1-\frac{\alpha}{2}}$)
8. Límite superior del IC ($\bar{X} + \sqrt{\frac{\bar{X}(1-\bar{X})}{n}} \cdot z_{1-\frac{\alpha}{2}}$)
```{r}
bmuIC <- function(n=50,N=10000,p=0.2,z=0.975)
{
  set.seed(123)

  df <- data.frame(matrix(NA,n,8))
  colnames(df) <- c('# de muestra','n','theta','media','desv. est.','error','LI','LS')
  
  for(i in 1:N)
  {
    x <- sample(c(0,1),size=n,replace = TRUE, prob = c(1-p,p))   # Creamos una muestra de tamaño N
    mu <- mean(x)
    sigma <- sqrt(mu*(1-mu)/n)
    error <- qnorm(z)*sigma
    
    df[i,1] <- i
    df[i,2] <- n
    df[i,3] <- p
    df[i,4] <- mu
    df[i,5] <- sigma
    df[i,6] <- error
    df[i,7] <- mu - error
    df[i,8] <- mu + error
  }
  
  return(df)
}
```


Función para contar la proporción de muestras cuyos intervalos de confianza contienen al valor del parámetro; es decir, si quisimos un IC del 95% para la muestra entonces el aproximadamente 95% de los IC de las muestras dadas deben contener al parámetro poblacional $\mu = 0$ (pues las muestras son normales estándar)
```{r}
bcuentaCI <- function(dataframe)
{
  p <- dataframe$theta[1]
  n <- dataframe$n
  N <- length(n)
  mu <- dataframe$media
  lower <- dataframe$LI
  upper <- dataframe$LS
  res <- 0
  c <- 0
  
  for(i in 1:N)
  {
    
    if(p>=lower[i] & p<=upper[i])
    {
      c = c + 1
    }
  }
  
  res <- c/N*100
  
  return(res)
  
}
```


Función para graficar los intervalos de confianza de las muestras dadas
```{r}
bgraphCI <- function(df,min=1,max=100)
{
  data <- df %>% slice(min:max)
  x <- data$`# de muestra`
  mu <- data$media
  p <- data$theta[1]
  L <- data$LI
  U <- data$LS
  
  ggplot(data, aes(x = x, y=mu, color=(L>p | U<p))) +
    geom_point(size = 3) +
    geom_hline(yintercept = p, color = 'red', size = 1) +
    geom_errorbar(aes(ymax = U, ymin = L)) +
    scale_colour_manual(values = c('gray20','red')) +
    ggtitle(expression('Intervalos de Confianza para '~mu)) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = 'none') +
    xlab('# de muestra') +
    ylab('IC')
}
```


Probamos con intervalos de confianza del $95\%$ (con $\alpha=0.05$ y $\frac{\alpha}{2} = 0.025$) y con $\theta = 0.4$
```{r}
b_ic95 <- bmuIC(p=0.4, z=0.975)
b_ic95

bcuentaCI(b_ic95)

bgraphCI(b_ic95,1,300)
```


Probamos con intervalos de confianza del $50\%$ (con $\alpha=0.5$ y $\frac{\alpha}{2} = 0.25$) y con $\theta = 0.2$
```{r}
b_ic50 <- bmuIC(p=0.2, z=0.75)
b_ic50

bcuentaCI(b_ic50)

bgraphCI(b_ic50,1,300)
```
